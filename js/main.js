// Generated by CoffeeScript 1.7.1
(function() {
  define(['utils', 'paper', 'coffee', 'mainRasterizer', 'coordinateSystems', 'global', 'ajax', 'options', 'socket', 'command', 'Item/item', 'Item/div', 'Item/lock', 'Item/path', 'Tool/tools', 'city', 'code', 'rasterizer', 'sound', 'modal', 'jquery', 'jqueryUi', 'mousewheel', 'scrollbar', 'tween', 'typeahead', 'modal', 'jqtree', 'ace'], function(utils, paper, CoffeeScript) {
    var g, init, initPosition, initTools;
    g = utils.g();
    g.rasterizerMode = window.rasterizerMode;
    if (g.rasterizerMode) {
      g.initializeRasterizerMode();
    }

    /*
    	 * Romanesco documentation #
    
    	Romanesco is an experiment about freedom, creativity and collaboration.
    
    	tododoc
    	tododoc: define RItems
    
    	The source code is divided in files:
    	 - [main.coffee](http://main.html) which is where the initialization
    	 - [path.coffee](http://path.html)
    	 - etc
    
    	Notations:
    	 - override means that the method extends functionnalities of the inherited method (super is called at some point)
    	 - redefine means that it totally replace the method (super is never called)
     */
    initTools = function() {
      var defaultFavoriteTools, error, pathClass, pathTool, _i, _len, _ref;
      g.toolsJ = $(".tool-list");
      g.toolsJ.find("[data-name='Create']").click(function() {
        var modal, submit;
        submit = function(data) {
          Dajaxice.draw.createCity(g.loadCityFromServer, {
            name: data.name,
            "public": data["public"]
          });
        };
        modal = g.RModal.createModal({
          title: 'Create city',
          submit: submit,
          postSubmit: 'load'
        });
        modal.addTextInput({
          label: "City name",
          name: 'name',
          required: true,
          submitShortcut: true,
          placeholder: 'Paris'
        });
        modal.addCheckbox({
          label: "Public",
          name: 'public',
          helpMessage: "Public cities will be accessible by anyone.",
          defaultValue: true
        });
        modal.show();
      });
      g.toolsJ.find("[data-name='Open']").click(function() {
        var modal;
        modal = g.RModal.createModal({
          title: 'Open city',
          name: 'open-city'
        });
        modal.modalBodyJ.find('.modal-footer').hide();
        modal.addProgressBar();
        modal.show();
        Dajaxice.draw.loadCities(g.loadCities);
      });
      g.favoriteToolsJ = $("#FavoriteTools .tool-list");
      g.allToolsContainerJ = $("#AllTools");
      g.allToolsJ = g.allToolsContainerJ.find(".all-tool-list");
      g.favoriteTools = [];
      if (typeof localStorage !== "undefined" && localStorage !== null) {
        try {
          g.favoriteTools = JSON.parse(localStorage.favorites);
        } catch (_error) {
          error = _error;
          console.log(error);
        }
      }
      defaultFavoriteTools = [g.PrecisePath, g.ThicknessPath, g.Meander, g.GeometricLines, g.RectangleShape, g.EllipseShape, g.StarShape, g.SpiralShape];
      while (g.favoriteTools.length < 8) {
        g.pushIfAbsent(g.favoriteTools, defaultFavoriteTools.pop().rname);
      }
      g.tools = {};
      new g.MoveTool();
      new g.CarTool();
      new g.SelectTool();
      new g.CodeTool();
      new g.LockTool(g.RLock);
      new g.TextTool(g.RText);
      new g.MediaTool(g.RMedia);
      new g.ScreenshotTool();
      new g.GradientTool();
      _ref = g.pathClasses;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        pathClass = _ref[_i];
        pathTool = new g.PathTool(pathClass);
      }
      g.tools['Move'].select();
      g.wacomPlugin = document.getElementById('wacomPlugin');
      if (g.wacomPlugin != null) {
        g.wacomPenAPI = wacomPlugin.penAPI;
        g.wacomTouchAPI = wacomPlugin.touchAPI;
        g.wacomPointerType = {
          0: 'Mouse',
          1: 'Pen',
          2: 'Puck',
          3: 'Eraser'
        };
      }
    };
    initPosition = function() {
      var box, boxRectangle, boxString, br, controller, folder, folderName, loadEntireArea, planet, pos, site, siteString, tl, _i, _len, _ref, _ref1;
      if (g.rasterizerMode) {
        return;
      }
      g.city = {
        owner: g.canvasJ.attr("data-owner"),
        city: g.canvasJ.attr("data-city"),
        site: g.canvasJ.attr("data-site")
      };
      boxString = g.canvasJ.attr("data-box");
      if (!boxString || boxString.length === 0) {
        window.onhashchange();
        return;
      }
      box = JSON.parse(boxString);
      planet = new Point(box.planetX, box.planetY);
      tl = g.posOnPlanetToProject(box.box.coordinates[0][0], planet);
      br = g.posOnPlanetToProject(box.box.coordinates[0][2], planet);
      boxRectangle = new Rectangle(tl, br);
      pos = boxRectangle.center;
      g.RMoveTo(pos);
      loadEntireArea = g.canvasJ.attr("data-load-entire-area");
      if (loadEntireArea) {
        g.entireArea = boxRectangle;
        g.load(boxRectangle);
      }
      siteString = g.canvasJ.attr("data-site");
      site = JSON.parse(siteString);
      if (site.restrictedArea) {
        g.restrictedArea = boxRectangle;
      }
      g.tools['Select'].select();
      if (site.disableToolbar) {
        g.sidebarJ.hide();
      } else {
        g.sidebarJ.find("div.panel.panel-default:not(:last)").hide();
        _ref = g.gui.__folders;
        for (folderName in _ref) {
          folder = _ref[folderName];
          _ref1 = folder.__controllers;
          for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
            controller = _ref1[_i];
            if (controller.name !== 'Zoom') {
              folder.remove(controller);
              folder.__controllers.remove(controller);
            }
          }
          if (folder.__controllers.length === 0) {
            g.gui.removeFolder(folderName);
          }
        }
        g.sidebarHandleJ.click();
      }
    };
    init = function() {
      g.romanescoURL = 'http://localhost:8000/';
      g.stageJ = $("#stage");
      g.sidebarJ = $("#sidebar");
      g.canvasJ = g.stageJ.find("#canvas");
      g.canvas = g.canvasJ[0];
      g.canvas.width = window.innerWidth;
      g.canvas.height = window.innerHeight;
      g.context = g.canvas.getContext('2d');
      g.me = null;
      g.selectionLayer = null;
      g.updateTimeout = {};
      g.requestedCallbacks = {};
      g.restrictedArea = null;
      g.OSName = "Unknown OS";
      g.currentPaths = {};
      g.loadingBarTimeout = null;
      g.entireArea = null;
      g.entireAreas = [];
      g.loadedAreas = [];
      g.paths = new Object();
      g.items = new Object();
      g.locks = [];
      g.divs = [];
      g.sortedPaths = [];
      g.sortedDivs = [];
      g.animatedItems = [];
      g.cars = {};
      g.alerts = null;
      g.scale = 1000.0;
      g.previousPoint = null;
      g.draggingEditor = false;
      g.areasToUpdate = {};
      g.rastersToUpload = [];
      g.areasToRasterize = [];
      g.isUpdatingRasters = false;
      g.viewUpdated = false;
      g.currentDiv = null;
      g.areasToUpdateRectangles = {};
      g.catchErrors = false;
      g.previousMousePosition = null;
      g.initialMousePosition = null;
      g.previousViewPosition = null;
      g.backgroundRectangle = null;
      g.limitPathV = null;
      g.limitPathH = null;
      g.selectedItems = [];
      g.ignoreSockets = false;
      g.mousePosition = new Point();
      g.hiddenDivs = [];
      g.itemListsJ = $("#RItems .layers");
      g.pathList = g.itemListsJ.find(".rPath-list");
      g.pathList.sortable({
        stop: g.zIndexSortStop,
        delay: 250
      });
      g.pathList.disableSelection();
      g.divList = g.itemListsJ.find(".rDiv-list");
      g.divList.sortable({
        stop: g.zIndexSortStop,
        delay: 250
      });
      g.divList.disableSelection();
      g.itemListsJ.find('.title').click(function(event) {
        $(this).parent().toggleClass('closed');
      });
      g.commandManager = new g.CommandManager();
      Dajaxice.setup({
        'default_exception_callback': function(error) {
          console.log('Dajaxice error!');
          g.romanesco_alert("Connection error", "error");
        }
      });
      if (navigator.appVersion.indexOf("Win") !== -1) {
        g.OSName = "Windows";
      }
      if (navigator.appVersion.indexOf("Mac") !== -1) {
        g.OSName = "MacOS";
      }
      if (navigator.appVersion.indexOf("X11") !== -1) {
        g.OSName = "UNIX";
      }
      if (navigator.appVersion.indexOf("Linux") !== -1) {
        g.OSName = "Linux";
      }
      paper.setup(g.canvas);
      g.project = project;
      g.mainLayer = project.activeLayer;
      g.mainLayer.name = 'main layer';
      g.debugLayer = new Layer();
      g.debugLayer.name = 'debug layer';
      g.carLayer = new Layer();
      g.carLayer.name = 'car layer';
      g.lockLayer = new Layer();
      g.lockLayer.name = 'lock layer';
      g.selectionLayer = new Layer();
      g.selectionLayer.name = 'selection layer';
      g.areasToUpdateLayer = new Layer();
      g.areasToUpdateLayer.name = 'areasToUpdateLayer';
      g.areasToUpdateLayer.visible = false;
      g.mainLayer.activate();
      paper.settings.hitTolerance = 5;
      g.grid = new Group();
      g.grid.name = 'grid group';
      view.zoom = 1;
      g.previousViewPosition = view.center;
      Point.prototype.toJSON = function() {
        return {
          x: this.x,
          y: this.y
        };
      };
      Point.prototype.exportJSON = function() {
        return JSON.stringify(this.toJSON());
      };
      Rectangle.prototype.toJSON = function() {
        return {
          x: this.x,
          y: this.y,
          width: this.width,
          height: this.height
        };
      };
      Rectangle.prototype.exportJSON = function() {
        return JSON.stringify(this.toJSON());
      };
      Rectangle.prototype.translate = function(point) {
        return new Rectangle(this.x + point.x, this.y + point.y, this.width, this.height);
      };
      Rectangle.prototype.moveSide = function(sideName, destination) {
        switch (sideName) {
          case 'left':
            this.x = destination;
            break;
          case 'right':
            this.x = destination - this.width;
            break;
          case 'top':
            this.y = destination;
            break;
          case 'bottom':
            this.y = destination - this.height;
        }
      };
      Rectangle.prototype.moveCorner = function(cornerName, destination) {
        switch (cornerName) {
          case 'topLeft':
            this.x = destination.x;
            this.y = destination.y;
            break;
          case 'topRight':
            this.x = destination.x - this.width;
            this.y = destination.y;
            break;
          case 'bottomRight':
            this.x = destination.x - this.width;
            this.y = destination.y - this.height;
            break;
          case 'bottomLeft':
            this.x = destination.x;
            this.y = destination.y - this.height;
        }
      };
      Rectangle.prototype.moveCenter = function(destination) {
        this.x = destination.x - this.width * 0.5;
        this.y = destination.y - this.height * 0.5;
      };
      Event.prototype.toJSON = function() {
        var event;
        event = {
          modifiers: this.modifiers,
          event: {
            which: this.event.which
          },
          point: this.point,
          downPoint: this.downPoint,
          delta: this.delta,
          middlePoint: this.middlePoint,
          type: this.type,
          count: this.count
        };
        return event;
      };
      Event.prototype.fromJSON = function(event) {
        if (event.point != null) {
          event.point = new Point(event.point);
        }
        if (event.downPoint != null) {
          event.downPoint = new Point(event.downPoint);
        }
        if (event.delta != null) {
          event.delta = new Point(event.delta);
        }
        if (event.middlePoint != null) {
          event.middlePoint = new Point(event.middlePoint);
        }
        return event;
      };
      g.alertsContainer = $("#Romanesco_alerts");
      g.alerts = [];
      g.currentAlert = -1;
      g.alertTimeOut = -1;
      g.alertsContainer.find(".btn-up").click(function() {
        return g.showAlert(g.currentAlert - 1);
      });
      g.alertsContainer.find(".btn-down").click(function() {
        return g.showAlert(g.currentAlert + 1);
      });
      g.sidebarHandleJ = g.sidebarJ.find(".sidebar-handle");
      g.sidebarHandleJ.click(function() {
        g.toggleSidebar();
      });
      g.sound = new g.RSound(['/static/sounds/viper.ogg']);
      g.initializeRasterizers();
      if (!g.rasterizerMode) {
        g.initParameters();
        g.initSocket();
        initTools();
        $(".mCustomScrollbar").mCustomScrollbar({
          keyboard: false
        });
      } else {
        g.initToolsRasterizer();
      }
      initPosition();
      g.updateGrid();
      if (typeof window.setPageFullyLoaded === "function") {
        window.setPageFullyLoaded(true);
      }
    };
    $(document).ready(function() {
      var focusIsOnCanvas, mousedown, mousemove, mouseup;
      init();
      if (g.rasterizerMode) {
        return;
      }
      g.canvasJ.dblclick(function(event) {
        var _base;
        return typeof (_base = g.selectedTool).doubleClick === "function" ? _base.doubleClick(event) : void 0;
      });
      g.canvasJ.keydown(function(event) {
        if (event.key === 46) {
          event.preventDefault();
          return false;
        }
      });
      g.tool = new Tool();
      focusIsOnCanvas = function() {
        return $(document.activeElement).is("body");
      };
      g.tool.onMouseDown = function(event) {
        var _ref;
        if ((_ref = g.wacomPenAPI) != null ? _ref.isEraser : void 0) {
          g.tool.onKeyUp({
            key: 'delete'
          });
          return;
        }
        $(document.activeElement).blur();
        g.selectedTool.begin(event);
      };
      g.tool.onMouseDrag = function(event) {
        var _ref;
        if ((_ref = g.wacomPenAPI) != null ? _ref.isEraser : void 0) {
          return;
        }
        if (g.currentDiv != null) {
          return;
        }
        g.selectedTool.update(event);
      };
      g.tool.onMouseUp = function(event) {
        var _ref;
        if ((_ref = g.wacomPenAPI) != null ? _ref.isEraser : void 0) {
          return;
        }
        if (g.currentDiv != null) {
          return;
        }
        g.selectedTool.end(event);
      };
      g.tool.onKeyDown = function(event) {
        if (!focusIsOnCanvas()) {
          return;
        }
        if (event.key === 'delete') {
          event.preventDefault();
          return false;
        }
        if (event.key === 'space' && g.selectedTool.name !== 'Move') {
          g.tools['Move'].select();
        }
      };
      g.tool.onKeyUp = function(event) {
        var _ref;
        if (!focusIsOnCanvas()) {
          return;
        }
        g.selectedTool.keyUp(event);
        switch (event.key) {
          case 'space':
            if ((_ref = g.previousTool) != null) {
              _ref.select();
            }
            break;
          case 'v':
            g.tools['Select'].select();
            break;
          case 't':
            g.showToolBox();
            break;
          case 'r':
            if (event.modifiers.shift) {
              g.rasterizer.rasterizeImmediately();
            }
        }
        event.preventDefault();
      };
      view.onFrame = function(event) {
        var car, direction, item, username, _base, _base1, _i, _len, _ref, _ref1;
        TWEEN.update(event.time);
        if (typeof (_base = g.rasterizer).updateLoadingBar === "function") {
          _base.updateLoadingBar(event.time);
        }
        if (typeof (_base1 = g.selectedTool).onFrame === "function") {
          _base1.onFrame(event);
        }
        _ref = g.animatedItems;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          item.onFrame(event);
        }
        _ref1 = g.cars;
        for (username in _ref1) {
          car = _ref1[username];
          direction = new Point(1, 0);
          direction.angle = car.rotation - 90;
          car.position = car.position.add(direction.multiply(car.speed));
          if (Date.now() - car.rLastUpdate > 1000) {
            g.cars[username].remove();
            delete g.cars[username];
          }
        }
      };
      $(window).resize(function(event) {
        g.updateGrid();
        $(".mCustomScrollbar").mCustomScrollbar("update");
        view.update();
        g.canvasJ.width(window.innerWidth);
        g.canvasJ.height(window.innerHeight);
        view.viewSize = new Size(window.innerWidth, window.innerHeight);
      });
      mousedown = function(event) {
        var _base;
        switch (event.which) {
          case 2:
            g.tools['Move'].select();
            break;
          case 3:
            if (typeof (_base = g.selectedTool).finish === "function") {
              _base.finish();
            }
        }
        if (g.selectedTool.name === 'Move') {
          g.selectedTool.beginNative(event);
          return;
        }
        g.initialMousePosition = g.jEventToPoint(event);
        g.previousMousePosition = g.initialMousePosition.clone();
      };
      mousemove = function(event) {
        var paperEvent, _base, _ref;
        g.mousePosition.x = event.pageX;
        g.mousePosition.y = event.pageY;
        if (g.selectedTool.name === 'Move' && g.selectedTool.dragging) {
          g.selectedTool.updateNative(event);
          return;
        }
        g.RDiv.updateHiddenDivs(event);
        if ((_ref = g.codeEditor) != null) {
          _ref.onMouseMove(event);
        }
        if (g.currentDiv != null) {
          paperEvent = g.jEventToPaperEvent(event, g.previousMousePosition, g.initialMousePosition, 'mousemove');
          if (typeof (_base = g.currentDiv).updateSelect === "function") {
            _base.updateSelect(paperEvent);
          }
          g.previousMousePosition = paperEvent.point;
        }
      };
      mouseup = function(event) {
        var paperEvent, _base, _ref, _ref1;
        if (g.stageJ.hasClass("has-tool-box") && !$(event.target).parents('.tool-box').length > 0) {
          g.hideToolBox();
        }
        if ((_ref = g.codeEditor) != null) {
          _ref.onMouseUp(event);
        }
        if (g.selectedTool.name === 'Move') {
          g.selectedTool.endNative(event);
          if (event.which === 2) {
            if ((_ref1 = g.previousTool) != null) {
              _ref1.select();
            }
          }
          return;
        }
        if (g.currentDiv != null) {
          paperEvent = g.jEventToPaperEvent(event, g.previousMousePosition, g.initialMousePosition, 'mouseup');
          if (typeof (_base = g.currentDiv).endSelect === "function") {
            _base.endSelect(paperEvent);
          }
          g.previousMousePosition = paperEvent.point;
        }
      };
      g.stageJ.mousedown(mousedown);
      $(window).mousemove(mousemove);
      $(window).mouseup(mouseup);
      g.stageJ.mousewheel(function(event) {
        g.RMoveBy(new Point(-event.deltaX, event.deltaY));
      });
      g.fileManager = new g.FileManager();
    });
    g.showCodeEditor = function(source) {
      if (g.codeEditor == null) {
        require(['editor'], function(CodeEditor) {
          g.codeEditor = new CodeEditor();
          if (source) {
            g.codeEditor.setSource(source);
          }
          g.codeEditor.open();
        });
      } else {
        if (source) {
          g.codeEditor.setSource(source);
        }
        g.codeEditor.open();
      }
    };
  });

}).call(this);

//# sourceMappingURL=main.map
