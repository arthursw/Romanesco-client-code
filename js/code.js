// Generated by CoffeeScript 1.7.1
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  define(['utils', 'jquery'], function(utils) {
    var FileManager, g;
    g = utils.g();
    FileManager = (function() {
      function FileManager() {
        this.onFileMoved = __bind(this.onFileMoved, this);
        this.loadFile = __bind(this.loadFile, this);
        this.readTree = __bind(this.readTree, this);
        this.loadTree = __bind(this.loadTree, this);
        this.fileBrowserJ = $('#Code').find('.files');
        this.files = [];
        this.nDirsToLoad = 1;
        this.request('https://api.github.com/repos/arthursw/romanesco-client-code/contents/', this.loadTree);
        return;
      }

      FileManager.prototype.request = function(request, callback) {
        Dajaxice.draw.githubRequest(callback, {
          githubRequest: request
        });
      };

      FileManager.prototype.createFile = function() {};

      FileManager.prototype.updateFile = function() {};

      FileManager.prototype.deleteFile = function() {};

      FileManager.prototype.getParentNode = function(file, node) {
        var dirName, dirs, i, _base, _i, _len;
        dirs = file.path.split('/');
        file.name = dirs.pop();
        for (i = _i = 0, _len = dirs.length; _i < _len; i = ++_i) {
          dirName = dirs[i];
          if ((_base = node.children)[dirName] == null) {
            _base[dirName] = {
              children: {}
            };
          }
          node = node.children[dirName];
        }
        return node;
      };

      FileManager.prototype.buildTree = function(files) {
        var file, node, tree, _base, _i, _len, _name;
        tree = {
          children: {}
        };
        for (_i = 0, _len = files.length; _i < _len; _i++) {
          file = files[_i];
          node = tree;
          node = this.getParentNode(file, node);
          if ((_base = node.children)[_name = file.name] == null) {
            _base[_name] = {
              children: {}
            };
          }
          node.children[file.name].type = file.type;
          node.children[file.name].path = file.path;
        }
        return tree;
      };

      FileManager.prototype.buildJqTree = function(tree, jqTree) {
        var jqTreeNode, name, node, _ref;
        _ref = tree.children;
        for (name in _ref) {
          node = _ref[name];
          jqTreeNode = {
            label: name,
            type: node.type,
            path: node.path,
            children: []
          };
          node.jqTreeNode = jqTreeNode;
          jqTree.children.push(jqTreeNode);
          this.buildJqTree(node, jqTreeNode);
        }
      };

      FileManager.prototype.loadTree = function(content) {
        var file, _i, _len;
        for (_i = 0, _len = content.length; _i < _len; _i++) {
          file = content[_i];
          if (file.name === 'coffee') {
            this.request(file.git_url + '?recursive=1', this.readTree);
            break;
          }
        }
      };

      FileManager.prototype.readTree = function(content) {
        var jqTreeData;
        this.tree = this.buildTree(content.tree);
        jqTreeData = {
          children: []
        };
        this.buildJqTree(this.tree, jqTreeData);
        this.fileBrowserJ.tree({
          data: jqTreeData.children,
          autoOpen: true,
          dragAndDrop: true,
          onCanMoveTo: function(moved_node, target_node, position) {
            return target_node.type === 'tree' || position !== 'inside';
          }
        });
        this.fileBrowserJ.bind('tree.select', this.loadFile);
        this.fileBrowserJ.bind('tree.move', this.onFileMoved);
      };

      FileManager.prototype.loadFile = function(event) {
        if (event.node.type === 'tree') {
          return;
        }
        this.request('https://api.github.com/repos/arthursw/romanesco-client-code/contents/coffee/' + event.node.path, this.openFile);
      };

      FileManager.prototype.openFile = function(content) {
        g.showCodeEditor(atob(content.content));
      };

      FileManager.prototype.onFileMoved = function(event) {
        console.log('moved_node', event.move_info.moved_node);
        console.log('target_node', event.move_info.target_node);
        console.log('position', event.move_info.position);
        console.log('previous_parent', event.move_info.previous_parent);
      };

      return FileManager;

    })();
    g.FileManager = FileManager;
  });

}).call(this);

//# sourceMappingURL=code.map
