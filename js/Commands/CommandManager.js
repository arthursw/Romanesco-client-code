// Generated by CoffeeScript 1.7.1
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __slice = [].slice;

  define(['Commands/Command'], function(Command) {
    var CommandManager;
    CommandManager = (function() {
      CommandManager.maxCommandNumber = 20;

      function CommandManager() {
        this.endAction = __bind(this.endAction, this);
        this.toggleCurrentCommand = __bind(this.toggleCurrentCommand, this);
        this.history = [];
        this.itemToCommands = {};
        this.currentCommand = -1;
        this.historyJ = $("#History ul.history");
        this.add(new Command('Loaded Romanesco'), true);
        return;
      }

      CommandManager.prototype.add = function(command, execute) {
        var currentLiJ, firstCommand, _ref;
        if (execute == null) {
          execute = false;
        }
        if (this.currentCommand >= this.constructor.maxCommandNumber - 1) {
          firstCommand = this.history.shift();
          firstCommand["delete"]();
          this.currentCommand--;
        }
        currentLiJ = (_ref = this.history[this.currentCommand]) != null ? _ref.liJ : void 0;
        if (currentLiJ != null) {
          currentLiJ.nextAll().remove();
        }
        this.historyJ.append(command.liJ);
        $("#History .mCustomScrollbar").mCustomScrollbar("scrollTo", "bottom");
        this.currentCommand++;
        this.history.splice(this.currentCommand, this.history.length - this.currentCommand, command);
        this.mapItemsToCommand(command);
        if (execute) {
          command["do"]();
        }
      };

      CommandManager.prototype.toggleCurrentCommand = function() {
        var deferred;
        console.log("toggleCurrentCommand");
        $('#loadingMask').css({
          'visibility': 'hidden'
        });
        document.removeEventListener('command executed', this.toggleCurrentCommand);
        if (this.currentCommand === this.commandIndex) {
          return;
        }
        deferred = this.history[this.currentCommand + this.offset].toggle();
        this.currentCommand += this.direction;
        if (deferred) {
          $('#loadingMask').css({
            'visibility': 'visible'
          });
          document.addEventListener('command executed', this.toggleCurrentCommand);
        } else {
          this.toggleCurrentCommand();
        }
      };

      CommandManager.prototype.commandClicked = function(command) {
        this.commandIndex = this.getCommandIndex(command);
        if (this.currentCommand === this.commandIndex) {
          return;
        }
        if (this.currentCommand > this.commandIndex) {
          this.direction = -1;
          this.offset = 0;
        } else {
          this.direction = 1;
          this.offset = 1;
        }
        this.toggleCurrentCommand();
      };

      CommandManager.prototype.getCommandIndex = function(command) {
        var c, i, _i, _len, _ref;
        _ref = this.history;
        for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
          c = _ref[i];
          if (c === command) {
            return i;
          }
        }
        return -1;
      };

      CommandManager.prototype.getCurrentCommand = function() {
        return this.history[this.currentCommand];
      };

      CommandManager.prototype.clearHistory = function() {
        this.historyJ.empty();
        this.history = [];
        this.currentCommand = -1;
        this.add(new Command("Load Romanesco"), true);
      };

      CommandManager.prototype.beginAction = function(command, event) {
        if (this.actionCommand != null) {
          clearTimeout(R.updateTimeout['addCurrentCommand-' + this.actionCommand.id]);
          this.endAction();
        }
        this.actionCommand = command;
        this.actionCommand.begin(event);
      };

      CommandManager.prototype.updateAction = function() {
        var _ref;
        if ((_ref = this.actionCommand) != null) {
          _ref.update.apply(this.actionCommand, arguments);
        }
      };

      CommandManager.prototype.endAction = function(event) {
        var _ref;
        if ((_ref = this.actionCommand) != null) {
          _ref.end(event);
        }
        this.actionCommand = null;
      };

      CommandManager.prototype.deferredAction = function() {
        var ActionCommand, args, event, items;
        ActionCommand = arguments[0], items = arguments[1], event = arguments[2], args = 4 <= arguments.length ? __slice.call(arguments, 3) : [];
        if (!ActionCommand.prototype.isPrototypeOf(this.actionCommand)) {
          this.beginAction(new ActionCommand(items, args), event);
        }
        this.updateAction.apply(this, args);
        Utils.deferredExecution(this.endAction, 'addCurrentCommand-' + this.actionCommand.id);
      };

      CommandManager.prototype.mapItemsToCommand = function(command) {
        var item, pk, _base, _ref;
        if (command.items == null) {
          return;
        }
        _ref = command.items;
        for (pk in _ref) {
          item = _ref[pk];
          if ((_base = this.itemToCommands)[pk] == null) {
            _base[pk] = [];
          }
          this.itemToCommands[pk].push(command);
        }
      };

      CommandManager.prototype.setItemPk = function(id, pk) {
        var command, commands, _i, _len;
        commands = this.itemToCommands[id];
        if (commands != null) {
          for (_i = 0, _len = commands.length; _i < _len; _i++) {
            command = commands[_i];
            command.setItemPk(id, pk);
          }
        }
        this.itemToCommands[pk] = this.itemToCommands[id];
        delete this.itemToCommands[id];
      };

      CommandManager.prototype.unloadItem = function(item) {
        var command, commands, _i, _len;
        commands = this.itemToCommands[item.getPk()];
        if (commands != null) {
          for (_i = 0, _len = commands.length; _i < _len; _i++) {
            command = commands[_i];
            command.unloadItem(item);
          }
        }
      };

      CommandManager.prototype.loadItem = function(item) {
        var command, commands, _i, _len;
        commands = this.itemToCommands[item.getPk()];
        if (commands != null) {
          for (_i = 0, _len = commands.length; _i < _len; _i++) {
            command = commands[_i];
            command.loadItem(item);
          }
        }
      };

      CommandManager.prototype.resurrectItem = function(pk, item) {
        var command, commands, _i, _len;
        commands = this.itemToCommands[pk];
        if (commands != null) {
          for (_i = 0, _len = commands.length; _i < _len; _i++) {
            command = commands[_i];
            command.resurrectItem(item);
          }
        }
        this.itemToCommands[item.getPk()] = commands;
        delete this.itemToCommands[pk];
      };

      return CommandManager;

    })();
    return CommandManager;
  });

}).call(this);
