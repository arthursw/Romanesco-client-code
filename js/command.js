// Generated by CoffeeScript 1.7.1
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['utils', 'item', 'jquery', 'paper'], function(utils) {
    var AddPointCommand, Command, CommandManager, CreateItemCommand, DeleteItemCommand, DeletePointCommand, DeselectCommand, DuplicateItemCommand, ModifyControlPathCommand, ModifyPointCommand, ModifyPointTypeCommand, ModifySpeedCommand, ModifyTextCommand, MoveCommand, MoveViewCommand, ResizeCommand, RotationCommand, SelectCommand, SetParameterCommand, g;
    g = utils.g();
    Command = (function() {
      Command.needValidPosition = false;

      function Command(name) {
        this.name = name;
        this.click = __bind(this.click, this);
        this.liJ = $("<li>").text(this.name);
        this.liJ.click(this.click);
        return;
      }

      Command.prototype.superDo = function() {
        this.done = true;
        this.liJ.addClass('done');
      };

      Command.prototype.superUndo = function() {
        this.done = false;
        this.liJ.removeClass('done');
      };

      Command.prototype["do"] = function() {
        this.superDo();
      };

      Command.prototype.undo = function() {
        this.superUndo();
      };

      Command.prototype.click = function() {
        g.commandManager.commandClicked(this);
      };

      Command.prototype.toggle = function() {
        if (this.done) {
          return this.undo();
        } else {
          return this["do"]();
        }
      };

      Command.prototype["delete"] = function() {
        this.liJ.remove();
      };

      Command.prototype.update = function() {};

      Command.prototype.end = function() {
        this.superDo();
      };

      return Command;

    })();
    g.Command = Command;
    ResizeCommand = (function(_super) {
      __extends(ResizeCommand, _super);

      ResizeCommand.needValidPosition = true;

      function ResizeCommand(item, newRectangle) {
        this.item = item;
        this.newRectangle = newRectangle;
        ResizeCommand.__super__.constructor.call(this, "Resize item", this.item);
        this.previousRectangle = this.item.rectangle;
        return;
      }

      ResizeCommand.prototype["do"] = function() {
        this.item.setRectangle(this.newRectangle, true);
        ResizeCommand.__super__["do"].call(this);
      };

      ResizeCommand.prototype.undo = function() {
        this.item.setRectangle(this.previousRectangle, true);
        ResizeCommand.__super__.undo.call(this);
      };

      ResizeCommand.prototype.update = function(event) {
        this.item.updateSetRectangle(event);
      };

      ResizeCommand.prototype.end = function(valid) {
        this.newRectangle = this.item.rectangle;
        if (this.newRectangle === this.previousRectangle) {
          return false;
        }
        if (!valid) {
          return false;
        }
        this.item.endSetRectangle();
        ResizeCommand.__super__.end.call(this);
        return true;
      };

      return ResizeCommand;

    })(Command);
    g.ResizeCommand = ResizeCommand;
    RotationCommand = (function(_super) {
      __extends(RotationCommand, _super);

      RotationCommand.needValidPosition = true;

      function RotationCommand(item, newRotation) {
        this.item = item;
        this.newRotation = newRotation;
        RotationCommand.__super__.constructor.call(this, "Rotate item");
        this.previousRotation = this.item.rotation;
        return;
      }

      RotationCommand.prototype["do"] = function() {
        this.item.setRotation(this.newRotation, true);
        RotationCommand.__super__["do"].call(this);
      };

      RotationCommand.prototype.undo = function() {
        this.item.setRotation(this.previousRotation, true);
        RotationCommand.__super__.undo.call(this);
      };

      RotationCommand.prototype.update = function(event) {
        this.item.updateSetRotation(event);
      };

      RotationCommand.prototype.end = function(valid) {
        this.newRotation = this.item.rotation;
        if (this.newRotation === this.previousRotation) {
          return false;
        }
        if (!valid) {
          return false;
        }
        this.item.endSetRotation();
        RotationCommand.__super__.end.call(this);
        return true;
      };

      return RotationCommand;

    })(Command);
    g.RotationCommand = RotationCommand;
    MoveCommand = (function(_super) {
      __extends(MoveCommand, _super);

      MoveCommand.needValidPosition = true;

      function MoveCommand(item, newPosition) {
        this.item = item;
        this.newPosition = newPosition;
        MoveCommand.__super__.constructor.call(this, "Move item");
        this.previousPosition = this.item.rectangle.center;
        this.items = g.selectedItems.slice();
        return;
      }

      MoveCommand.prototype["do"] = function() {
        var item, _i, _len, _ref;
        _ref = this.items;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          item.moveBy(this.newPosition.subtract(this.previousPosition), true);
        }
        MoveCommand.__super__["do"].call(this);
      };

      MoveCommand.prototype.undo = function() {
        var item, _i, _len, _ref;
        _ref = this.items;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          item.moveBy(this.previousPosition.subtract(this.newPosition), true);
        }
        MoveCommand.__super__.undo.call(this);
      };

      MoveCommand.prototype.update = function(event) {
        var item, _i, _len, _ref;
        _ref = this.items;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          item.updateMove(event);
        }
      };

      MoveCommand.prototype.end = function(valid) {
        var args, item, _i, _len, _ref;
        this.newPosition = this.item.rectangle.center;
        if (this.newPosition.equals(this.previousPosition)) {
          return false;
        }
        if (!valid) {
          return false;
        }
        if (this.items.length === 1) {
          this.items[0].endMove(true);
        } else {
          args = [];
          _ref = this.items;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            item = _ref[_i];
            item.endMove(false);
            if (g.RLock.prototype.isPrototypeOf(item)) {
              item.update('position');
            } else {
              args.push({
                "function": item.getUpdateFunction(),
                "arguments": item.getUpdateArguments('position')
              });
            }
          }
          Dajaxice.draw.multipleCalls(this.updateCallback, {
            functionsAndArguments: args
          });
        }
        MoveCommand.__super__.end.call(this);
        return true;
      };

      MoveCommand.prototype.updateCallback = function(results) {
        var result, _i, _len;
        for (_i = 0, _len = results.length; _i < _len; _i++) {
          result = results[_i];
          g.checkError(result);
        }
      };

      return MoveCommand;

    })(Command);
    g.MoveCommand = MoveCommand;
    ModifyPointCommand = (function(_super) {
      __extends(ModifyPointCommand, _super);

      ModifyPointCommand.needValidPosition = true;

      function ModifyPointCommand(item) {
        this.item = item;
        this.segment = this.item.selectionState.segment;
        this.previousPosition = new Point(this.segment.point);
        this.previousHandleIn = new Point(this.segment.handleIn);
        this.previousHandleOut = new Point(this.segment.handleOut);
        ModifyPointCommand.__super__.constructor.call(this, 'Modify point');
        return;
      }

      ModifyPointCommand.prototype["do"] = function() {
        this.item.modifyPoint(this.segment, this.position, this.handleIn, this.handleOut);
        ModifyPointCommand.__super__["do"].call(this);
      };

      ModifyPointCommand.prototype.undo = function() {
        this.item.modifyPoint(this.segment, this.previousPosition, this.previousHandleIn, this.previousHandleOut);
        ModifyPointCommand.__super__.undo.call(this);
      };

      ModifyPointCommand.prototype.update = function(event) {
        this.item.updateModifyPoint(event);
      };

      ModifyPointCommand.prototype.end = function(valid) {
        var handleInNotChanged, handleOutNotChanged, positionNotChanged;
        this.position = this.segment.point.clone();
        this.handleIn = this.segment.handleIn.clone();
        this.handleOut = this.segment.handleOut.clone();
        if (!valid) {
          return;
        }
        positionNotChanged = this.position.equals(this.previousPosition);
        handleInNotChanged = this.previousHandleIn.equals(this.handleIn);
        handleOutNotChanged = this.previousHandleOut.equals(this.handleOut);
        if (positionNotChanged && handleInNotChanged && handleOutNotChanged) {
          return false;
        }
        this.item.endModifyPoint();
        ModifyPointCommand.__super__.end.call(this);
        return true;
      };

      return ModifyPointCommand;

    })(Command);
    g.ModifyPointCommand = ModifyPointCommand;
    ModifySpeedCommand = (function(_super) {
      __extends(ModifySpeedCommand, _super);

      function ModifySpeedCommand(item) {
        this.item = item;
        this.previousSpeeds = this.item.speeds.slice();
        ModifySpeedCommand.__super__.constructor.call(this, 'Change speed');
        return;
      }

      ModifySpeedCommand.prototype["do"] = function() {
        this.item.modifySpeed(this.speeds, true);
        ModifySpeedCommand.__super__["do"].call(this);
      };

      ModifySpeedCommand.prototype.undo = function() {
        this.speeds = this.item.speeds.slice();
        this.item.modifySpeed(this.previousSpeeds, true);
        ModifySpeedCommand.__super__.undo.call(this);
      };

      ModifySpeedCommand.prototype.update = function(event) {
        this.item.updateModifySpeed(event);
      };

      ModifySpeedCommand.prototype.end = function(valid) {
        if (!valid) {
          return;
        }
        this.item.endModifySpeed();
        ModifySpeedCommand.__super__.end.call(this);
        return true;
      };

      return ModifySpeedCommand;

    })(Command);
    g.ModifySpeedCommand = ModifySpeedCommand;
    SetParameterCommand = (function(_super) {
      __extends(SetParameterCommand, _super);

      function SetParameterCommand(item, args) {
        this.item = item;
        this.controller = args[0];
        this.previousValue = this.item.data[this.controller.name];
        SetParameterCommand.__super__.constructor.call(this, 'Change item parameter "' + this.controller.name + '"');
        return;
      }

      SetParameterCommand.prototype["do"] = function() {
        this.item.setParameter(this.controller, this.value, true);
        SetParameterCommand.__super__["do"].call(this);
      };

      SetParameterCommand.prototype.undo = function() {
        this.item.setParameter(this.controller, this.previousValue, true);
        SetParameterCommand.__super__.undo.call(this);
      };

      SetParameterCommand.prototype.update = function(controller, value) {
        this.item.setParameter(controller, value);
      };

      SetParameterCommand.prototype.end = function(valid) {
        this.value = this.item.data[this.controller.name];
        if (this.value === this.previousValue) {
          return false;
        }
        if (!valid) {
          return;
        }
        this.item.update(this.controller.name);
        SetParameterCommand.__super__.end.call(this);
        return true;
      };

      return SetParameterCommand;

    })(Command);
    g.SetParameterCommand = SetParameterCommand;
    AddPointCommand = (function(_super) {
      __extends(AddPointCommand, _super);

      AddPointCommand.needValidPosition = true;

      function AddPointCommand(item, location, name) {
        this.item = item;
        this.location = location;
        if (name == null) {
          name = null;
        }
        AddPointCommand.__super__.constructor.call(this, name == null ? 'Add point on item' : name);
        return;
      }

      AddPointCommand.prototype.addPoint = function(update) {
        if (update == null) {
          update = true;
        }
        this.segment = this.item.addPointAt(this.location, update);
      };

      AddPointCommand.prototype.deletePoint = function() {
        this.location = this.item.deletePoint(this.segment);
      };

      AddPointCommand.prototype["do"] = function() {
        this.addPoint();
        AddPointCommand.__super__["do"].call(this);
      };

      AddPointCommand.prototype.undo = function() {
        this.deletePoint();
        AddPointCommand.__super__.undo.call(this);
      };

      return AddPointCommand;

    })(Command);
    g.AddPointCommand = AddPointCommand;
    DeletePointCommand = (function(_super) {
      __extends(DeletePointCommand, _super);

      DeletePointCommand.needValidPosition = true;

      function DeletePointCommand(item, segment) {
        this.item = item;
        this.segment = segment;
        DeletePointCommand.__super__.constructor.call(this, this.item, this.segment, 'Delete point on item');
      }

      DeletePointCommand.prototype["do"] = function() {
        this.previousPosition = new Point(this.segment.point);
        this.previousHandleIn = new Point(this.segment.handleIn);
        this.previousHandleOut = new Point(this.segment.handleOut);
        this.deletePoint();
        this.superDo();
      };

      DeletePointCommand.prototype.undo = function() {
        this.addPoint(false);
        this.item.modifyPoint(this.segment, this.previousPosition, this.previousHandleIn, this.previousHandleOut);
        this.superUndo();
      };

      return DeletePointCommand;

    })(AddPointCommand);
    g.DeletePointCommand = DeletePointCommand;
    ModifyPointTypeCommand = (function(_super) {
      __extends(ModifyPointTypeCommand, _super);

      ModifyPointTypeCommand.needValidPosition = true;

      function ModifyPointTypeCommand(item, segment, rtype) {
        this.item = item;
        this.segment = segment;
        this.rtype = rtype;
        this.previousRType = this.segment.rtype;
        this.previousPosition = new Point(this.segment.point);
        this.previousHandleIn = new Point(this.segment.handleIn);
        this.previousHandleOut = new Point(this.segment.handleOut);
        ModifyPointTypeCommand.__super__.constructor.call(this, 'Change point type on item');
        return;
      }

      ModifyPointTypeCommand.prototype["do"] = function() {
        this.item.modifyPointType(this.segment, this.rtype);
        ModifyPointTypeCommand.__super__["do"].call(this);
      };

      ModifyPointTypeCommand.prototype.undo = function() {
        this.item.modifyPointType(this.segment, this.previousRType, true, false);
        this.item.changeSegment(this.segment, this.previousPosition, this.previousHandleIn, this.previousHandleOut);
        ModifyPointTypeCommand.__super__.undo.call(this);
      };

      return ModifyPointTypeCommand;

    })(Command);
    g.ModifyPointTypeCommand = ModifyPointTypeCommand;

    /* --- Custom command for all kinds of command which modifiy the path --- */
    ModifyControlPathCommand = (function(_super) {
      __extends(ModifyControlPathCommand, _super);

      ModifyControlPathCommand.needValidPosition = true;

      function ModifyControlPathCommand(item, previousPointsAndPlanet, newPointsAndPlanet) {
        this.item = item;
        this.previousPointsAndPlanet = previousPointsAndPlanet;
        this.newPointsAndPlanet = newPointsAndPlanet;
        ModifyControlPathCommand.__super__.constructor.call(this, 'Modify path');
        this.superDo();
        return;
      }

      ModifyControlPathCommand.prototype["do"] = function() {
        this.item.modifyControlPath(this.newPointsAndPlanet);
        ModifyControlPathCommand.__super__["do"].call(this);
      };

      ModifyControlPathCommand.prototype.undo = function() {
        this.item.modifyControlPath(this.previousPointsAndPlanet);
        ModifyControlPathCommand.__super__.undo.call(this);
      };

      return ModifyControlPathCommand;

    })(Command);
    g.ModifyControlPathCommand = ModifyControlPathCommand;
    MoveViewCommand = (function(_super) {
      __extends(MoveViewCommand, _super);

      function MoveViewCommand(previousPosition, newPosition) {
        this.previousPosition = previousPosition;
        this.newPosition = newPosition;
        this.updateCommandItems = __bind(this.updateCommandItems, this);
        MoveViewCommand.__super__.constructor.call(this, "Move view");
        this.superDo();
        return;
      }

      MoveViewCommand.prototype.updateCommandItems = function() {
        var command, i, item, _i, _j, _len, _len1, _ref, _ref1;
        console.log("updateCommandItems");
        document.removeEventListener('command executed', this.updateCommandItems);
        _ref = g.commandManager.history;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          command = _ref[_i];
          if (command.item != null) {
            if ((command.item.group == null) && g.items[command.item.pk || command.item.id]) {
              command.item = g.items[command.item.pk || command.item.id];
            }
          }
          if (command.items != null) {
            _ref1 = command.items;
            for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
              item = _ref1[i];
              if ((item.group == null) && g.items[item.pk || item.id]) {
                command.items[i] = g.items[item.pk || item.id];
              }
            }
          }
        }
      };

      MoveViewCommand.prototype["do"] = function() {
        var somethingToLoad;
        somethingToLoad = g.RMoveBy(this.newPosition.subtract(this.previousPosition), false);
        if (somethingToLoad) {
          document.addEventListener('command executed', this.updateCommandItems);
        }
        MoveViewCommand.__super__["do"].call(this);
        return somethingToLoad;
      };

      MoveViewCommand.prototype.undo = function() {
        var somethingToLoad;
        somethingToLoad = g.RMoveBy(this.previousPosition.subtract(this.newPosition), false);
        if (somethingToLoad) {
          document.addEventListener('command executed', this.updateCommandItems);
        }
        MoveViewCommand.__super__.undo.call(this);
        return somethingToLoad;
      };

      return MoveViewCommand;

    })(Command);
    g.MoveViewCommand = MoveViewCommand;
    SelectCommand = (function(_super) {
      __extends(SelectCommand, _super);

      function SelectCommand(items, name) {
        this.items = items;
        SelectCommand.__super__.constructor.call(this, name || "Select items");
        return;
      }

      SelectCommand.prototype.selectItems = function() {
        var item, _i, _len, _ref;
        _ref = this.items;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          item.select();
        }
        g.controllerManager.updateParametersForSelectedItems();
      };

      SelectCommand.prototype.deselectItems = function() {
        var item, _i, _len, _ref;
        _ref = this.items;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          item.deselect();
        }
        g.controllerManager.updateParametersForSelectedItems();
      };

      SelectCommand.prototype["do"] = function() {
        this.selectItems();
        SelectCommand.__super__["do"].call(this);
      };

      SelectCommand.prototype.undo = function() {
        this.deselectItems();
        SelectCommand.__super__.undo.call(this);
      };

      return SelectCommand;

    })(Command);
    g.SelectCommand = SelectCommand;
    DeselectCommand = (function(_super) {
      __extends(DeselectCommand, _super);

      function DeselectCommand(items) {
        DeselectCommand.__super__.constructor.call(this, items || g.selectedItems.slice(), 'Deselect items');
        return;
      }

      DeselectCommand.prototype["do"] = function() {
        this.deselectItems();
        this.superDo();
      };

      DeselectCommand.prototype.undo = function() {
        this.selectItems();
        this.superUndo();
      };

      return DeselectCommand;

    })(SelectCommand);
    g.DeselectCommand = DeselectCommand;
    CreateItemCommand = (function(_super) {
      __extends(CreateItemCommand, _super);

      CreateItemCommand.needValidPosition = true;

      function CreateItemCommand(item, name) {
        this.item = item;
        if (name == null) {
          name = null;
        }
        if (name == null) {
          name = 'Create item';
        }
        this.itemConstructor = this.item.constructor;
        CreateItemCommand.__super__.constructor.call(this, name);
        this.superDo();
        return;
      }

      CreateItemCommand.prototype.setDuplicatedItemToCommands = function() {
        var command, i, item, _i, _j, _len, _len1, _ref, _ref1;
        _ref = g.commandManager.history;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          command = _ref[_i];
          if (command === this) {
            continue;
          }
          if ((command.item != null) && command.item === this.itemPk) {
            command.item = this.item;
          }
          if (command.items != null) {
            _ref1 = command.items;
            for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
              item = _ref1[i];
              if (item === this.itemPk) {
                command.items[i] = this.item;
              }
            }
          }
        }
      };

      CreateItemCommand.prototype.removeDeleteItemFromCommands = function() {
        var command, i, item, _i, _j, _len, _len1, _ref, _ref1;
        _ref = g.commandManager.history;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          command = _ref[_i];
          if (command === this) {
            continue;
          }
          if ((command.item != null) && command.item === this.item) {
            command.item = this.item.pk || this.item.id;
          }
          if (command.items != null) {
            _ref1 = command.items;
            for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
              item = _ref1[i];
              if (item === this.item) {
                command.items[i] = this.item.pk || this.item.id;
              }
            }
          }
        }
        this.itemPk = this.item.pk || this.item.id;
      };

      CreateItemCommand.prototype.duplicateItem = function() {
        this.item = this.itemConstructor.create(this.duplicateData);
        this.setDuplicatedItemToCommands();
        this.item.select();
      };

      CreateItemCommand.prototype.deleteItem = function() {
        this.removeDeleteItemFromCommands();
        this.duplicateData = this.item.getDuplicateData();
        this.item["delete"]();
        this.item = null;
      };

      CreateItemCommand.prototype["do"] = function() {
        this.duplicateItem();
        CreateItemCommand.__super__["do"].call(this);
      };

      CreateItemCommand.prototype.undo = function() {
        this.deleteItem();
        CreateItemCommand.__super__.undo.call(this);
      };

      return CreateItemCommand;

    })(Command);
    g.CreateItemCommand = CreateItemCommand;
    DeleteItemCommand = (function(_super) {
      __extends(DeleteItemCommand, _super);

      function DeleteItemCommand(item) {
        DeleteItemCommand.__super__.constructor.call(this, item, 'Delete item');
      }

      DeleteItemCommand.prototype["do"] = function() {
        this.deleteItem();
        this.superDo();
      };

      DeleteItemCommand.prototype.undo = function() {
        this.duplicateItem();
        this.superUndo();
      };

      return DeleteItemCommand;

    })(CreateItemCommand);
    g.DeleteItemCommand = DeleteItemCommand;
    DuplicateItemCommand = (function(_super) {
      __extends(DuplicateItemCommand, _super);

      function DuplicateItemCommand(item) {
        this.duplicateData = item.getDuplicateData();
        DuplicateItemCommand.__super__.constructor.call(this, item, 'Duplicate item');
      }

      return DuplicateItemCommand;

    })(CreateItemCommand);
    g.DuplicateItemCommand = DuplicateItemCommand;
    ModifyTextCommand = (function(_super) {
      __extends(ModifyTextCommand, _super);

      function ModifyTextCommand(item, args) {
        this.item = item;
        ModifyTextCommand.__super__.constructor.call(this, "Change text", this.item);
        this.newText = args[0];
        this.previousText = this.item.data.message;
        return;
      }

      ModifyTextCommand.prototype["do"] = function() {
        this.item.data.message = this.newText;
        this.item.contentJ.val(this.newText);
        ModifyTextCommand.__super__["do"].call(this);
      };

      ModifyTextCommand.prototype.undo = function() {
        this.item.data.message = this.previousText;
        this.item.contentJ.val(this.previousText);
        ModifyTextCommand.__super__.undo.call(this);
      };

      ModifyTextCommand.prototype.update = function(newText) {
        this.newText = newText;
        this.item.setText(this.newText, false);
      };

      ModifyTextCommand.prototype.end = function(valid) {
        if (this.newText === this.previousText) {
          return false;
        }
        if (!valid) {
          return false;
        }
        this.item.update('text');
        ModifyTextCommand.__super__.end.call(this);
        return true;
      };

      return ModifyTextCommand;

    })(Command);
    g.ModifyTextCommand = ModifyTextCommand;
    CommandManager = (function() {
      CommandManager.maxCommandNumber = 20;

      function CommandManager() {
        this.toggleCurrentCommand = __bind(this.toggleCurrentCommand, this);
        this.history = [];
        this.currentCommand = -1;
        this.historyJ = $("#History ul.history");
        return;
      }

      CommandManager.prototype.add = function(command, execute) {
        var currentLiJ, firstCommand, _ref;
        if (execute == null) {
          execute = false;
        }
        if (this.currentCommand >= this.constructor.maxCommandNumber - 1) {
          firstCommand = this.history.shift();
          firstCommand["delete"]();
          this.currentCommand--;
        }
        currentLiJ = (_ref = this.history[this.currentCommand]) != null ? _ref.liJ : void 0;
        if (currentLiJ != null) {
          currentLiJ.nextAll().remove();
        }
        this.historyJ.append(command.liJ);
        $("#History .mCustomScrollbar").mCustomScrollbar("scrollTo", "bottom");
        this.currentCommand++;
        this.history.splice(this.currentCommand, this.history.length - this.currentCommand, command);
        if (execute) {
          command["do"]();
        }
      };

      CommandManager.prototype.toggleCurrentCommand = function() {
        var deferred;
        console.log("toggleCurrentCommand");
        $('#loadingMask').css({
          'visibility': 'hidden'
        });
        document.removeEventListener('command executed', this.toggleCurrentCommand);
        if (this.currentCommand === this.commandIndex) {
          return;
        }
        deferred = this.history[this.currentCommand + this.offset].toggle();
        this.currentCommand += this.direction;
        if (deferred) {
          $('#loadingMask').css({
            'visibility': 'visible'
          });
          document.addEventListener('command executed', this.toggleCurrentCommand);
        } else {
          this.toggleCurrentCommand();
        }
      };

      CommandManager.prototype.commandClicked = function(command) {
        this.commandIndex = this.getCommandIndex(command);
        if (this.currentCommand === this.commandIndex) {
          return;
        }
        if (this.currentCommand > this.commandIndex) {
          this.direction = -1;
          this.offset = 0;
        } else {
          this.direction = 1;
          this.offset = 1;
        }
        this.toggleCurrentCommand();
      };

      CommandManager.prototype.getCommandIndex = function(command) {
        var c, i, _i, _len, _ref;
        _ref = this.history;
        for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
          c = _ref[i];
          if (c === command) {
            return i;
          }
        }
        return -1;
      };

      CommandManager.prototype.getCurrentCommand = function() {
        return this.history[this.currentCommand];
      };

      CommandManager.prototype.clearHistory = function() {
        this.historyJ.empty();
        this.history = [];
        this.currentCommand = -1;
        this.add(new g.Command("Load Romanesco"), true);
      };

      return CommandManager;

    })();
    g.CommandManager = CommandManager;
  });

}).call(this);

//# sourceMappingURL=command.map
