// Generated by CoffeeScript 1.7.1
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['Tool'], function(Tool) {
    Tool.Car = (function(_super) {
      __extends(Car, _super);

      Car.label = 'Car';

      Car.description = '';

      Car.iconURL = 'car.png';

      Car.favorite = true;

      Car.category = '';

      Car.cursor = {
        position: {
          x: 0,
          y: 0
        },
        name: 'default'
      };

      Car.initializeParameters = function() {
        var parameters;
        parameters = {
          'Car': {
            speed: {
              type: 'string',
              label: 'Speed',
              "default": '0',
              addController: true,
              onChange: function() {}
            },
            volume: {
              type: 'slider',
              label: 'Volume',
              "default": 1,
              min: 0,
              max: 10,
              onChange: function(value) {
                if (R.selectedTool.constructor.name === "CarTool") {
                  if (value > 0) {
                    if (!R.sound.isPlaying) {
                      R.sound.play();
                      R.sound.setLoopStart(3.26);
                      R.sound.setLoopEnd(5.22);
                    }
                    R.sound.setVolume(0.1 * value);
                  } else {
                    R.sound.stop();
                  }
                }
              }
            }
          }
        };
        return parameters;
      };

      Car.parameters = Car.initializeParameters();

      function Car() {
        Car.__super__.constructor.call(this, true);
        return;
      }

      Car.prototype.select = function(deselectItems, updateParameters) {
        if (deselectItems == null) {
          deselectItems = true;
        }
        if (updateParameters == null) {
          updateParameters = true;
        }
        Car.__super__.select.apply(this, arguments);
        this.car = new Raster("/static/images/car.png");
        R.carLayer.addChild(this.car);
        this.car.position = P.view.center;
        this.car.speed = 0;
        this.car.direction = new P.Point(0, -1);
        this.car.onLoad = function() {
          console.log('car loaded');
        };
        this.car.previousSpeed = 0;
        R.sound.setVolume(0.1);
        R.sound.play(0);
        R.sound.setLoopStart(3.26);
        R.sound.setLoopEnd(5.22);
        this.lastUpdate = Date.now();
      };

      Car.prototype.deselect = function() {
        Car.__super__.deselect.call(this);
        this.car.remove();
        this.car = null;
        R.sound.stop();
      };

      Car.prototype.onFrame = function() {
        var maxRate, maxSpeed, minRate, minSpeed, rate;
        if (this.car == null) {
          return;
        }
        minSpeed = 0.05;
        maxSpeed = 100;
        if (Key.isDown('right')) {
          this.car.direction.angle += 5;
        }
        if (Key.isDown('left')) {
          this.car.direction.angle -= 5;
        }
        if (Key.isDown('up')) {
          if (this.car.speed < maxSpeed) {
            this.car.speed++;
          }
        } else if (Key.isDown('down')) {
          if (this.car.speed > -maxSpeed) {
            this.car.speed--;
          }
        } else {
          this.car.speed *= 0.9;
          if (Math.abs(this.car.speed) < minSpeed) {
            this.car.speed = 0;
          }
        }
        minRate = 0.25;
        maxRate = 3;
        rate = minRate + Math.abs(this.car.speed) / maxSpeed * (maxRate - minRate);
        R.sound.setRate(rate);
        this.car.previousSpeed = this.car.speed;
        this.constructor.parameters['Car'].speed.controller.setValue(this.car.speed.toFixed(2), false);
        this.car.rotation = this.car.direction.angle + 90;
        if (Math.abs(this.car.speed) > minSpeed) {
          this.car.position = this.car.position.add(this.car.direction.multiply(this.car.speed));
          View.moveTo(this.car.position);
        }
        if (Date.now() - this.lastUpdate > 150) {
          if (R.me != null) {
            R.chatSocket.emit("car move", R.me, this.car.position, this.car.rotation, this.car.speed);
          }
          this.lastUpdate = Date.now();
        }
      };

      Car.prototype.keyUp = function(event) {
        switch (event.key) {
          case 'escape':
            R.tools['Move'].select();
        }
      };

      return Car;

    })(Tool);
    new Tool.Car();
    return Tool.Car;
  });

}).call(this);

//# sourceMappingURL=Car.map
